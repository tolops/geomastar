version: '3.8'

services:
  browserless:
    image: 'browserless/chrome:latest'
    container_name: geomaster-browserless
    restart: unless-stopped
    environment:
      - CONCURRENT=10
      - 'TOKEN=${BROWSERLESS_TOKEN:-your_token_fallback}'
      - MAX_CONCURRENT_SESSIONS=10
      - TIMEOUT=300000
      - KEEP_ALIVE=true
      - 'DEFAULT_LAUNCH_ARGS=["--no-sandbox","--disable-setuid-sandbox","--disable-blink-features=AutomationControlled"]'

  server:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: geomaster-server
    restart: unless-stopped
    environment:
      - PORT=3000
      # We use the ${DATABASE_URL} variable so Coolify injects the external DB string
      - 'DATABASE_URL=${DATABASE_URL}'
      - 'BROWSERLESS_URL=ws://browserless:3000'
      - 'TAVILY_API_KEY=${TAVILY_API_KEY}'
      - 'EXA_API_KEY=${EXA_API_KEY}'
      - 'FIRECRAWL_API_KEY=${FIRECRAWL_API_KEY}'
      - 'OPENAI_API_KEY=${OPENAI_API_KEY}'
    depends_on:
      # We only wait for browserless now, since Postgres is external
      browserless:
        condition: service_started

  client:
    build:
      context: ./client
      dockerfile: Dockerfile
    container_name: geomaster-client
    restart: unless-stopped
    environment:
      # Use the variable so the frontend knows where the backend lives on the internet
      - 'VITE_API_URL=${VITE_API_URL}'
    depends_on:
      - server

networks:
  default:
    name: geomaster-network
